#!/bin/bash

# Store the previous and current commit refs
prev_commit="$1"
new_commit="$2"

# Get a list of Rails migration files that only exist in the previous commit
prev_migrations=$(git diff --name-only $new_commit..$prev_commit | grep db/migrate)

# Loop through the previous migrations and check if they exist in the new commit
for migration in $prev_migrations; do
  # Extract the migration version number
  migration_version=$(basename "$migration" | cut -d '_' -f 1)
  
  # Check if migration exists in the new commit
  if ! git show "$new_commit:$migration" >/dev/null 2>&1; then
    echo "Rolling back migration: $migration_version"
    
    # Temporarily check out the migration file to its original location
    git checkout "$prev_commit" -- "$migration"
    
    # Rollback the migration
    bundle exec rails db:migrate:down VERSION="$migration_version"
    echo "Rolled back migration: $migration_version"
    
    # Remove the temporarily checked out migration file
    rm "$migration"
  fi
done
